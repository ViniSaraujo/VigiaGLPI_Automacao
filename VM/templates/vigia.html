<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Infra | GLPI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f8fafc; --text-muted: #94a3b8;
            --border-color: #334155;
            --new-color: #10b981; --n1-color: #3b82f6; --n3-color: #f97316; --danger-color: #ef4444;
            --stat-today-c: #60a5fa; --stat-today-s: #4ade80; 
            --stat-month-c: #818cf8; --stat-month-s: #fbbf24;
        }
        body { background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; padding: 20px; }
        
        #refresh-container { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: rgba(0,0,0,0.2); z-index: 9999; }
        #refresh-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--new-color), var(--n1-color), var(--danger-color)); transition: width 1s linear; }
        
        /* Classes utilitárias para o JS */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .theme-switch { cursor: pointer; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .stats-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-val { font-size: 2.2rem; font-weight: 900; line-height: 1; }
        .stat-label { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; color: var(--text-muted); display: block; margin-top: 5px; }
        .stat-icon { font-size: 1.8rem; opacity: 0.2; }
        
        .alert-box { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 12px; padding: 15px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); } 70% { box-shadow: 0 0 0 10px rgba(239,68,68,0); } 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); } }
        .btn-ticket { background: var(--bg-card); color: var(--danger-color); border: 1px solid var(--danger-color); padding: 3px 8px; border-radius: 6px; text-decoration: none; font-weight: bold; margin: 2px; font-size: 0.9rem; }
        
        .new-tickets-box { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 15px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
        .btn-new { background: var(--bg-card); color: var(--new-color); border: 1px solid var(--new-color); padding: 3px 8px; border-radius: 6px; text-decoration: none; font-weight: bold; margin: 2px; font-size: 0.9rem; }

        .card-queue { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; text-align: center; height: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .queue-title { color: var(--text-muted); font-weight: 600; margin-bottom: 5px; }
        .queue-count { font-size: 3.5rem; font-weight: 900; margin-bottom: 5px; }
        .n1n2 { color: var(--n1-color); } .n3 { color: var(--n3-color); } .novos { color: var(--new-color); }
        .sla-alert { color: var(--danger-color); font-weight: bold; animation: blink 1s infinite; font-size: 0.8rem; display: block; margin-top: 5px; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .ranking-container { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 15px; height: 100%; }
        .nav-tabs { border-bottom: 1px solid var(--border-color); }
        .nav-link { color: var(--text-muted); border: none; }
        .nav-link.active { color: #fff; background: transparent; border-bottom: 2px solid var(--n1-color); }
        .rank-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 0.95rem; }
        .rank-score { background: rgba(255,255,255,0.05); padding: 2px 8px; border-radius: 4px; font-weight: bold; color: var(--n1-color); }
        .chart-box { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 10px; height: 300px; }
        body:not(.dark-mode) { --bg-body: #f3f4f6; --bg-card: #ffffff; --text-main: #1f2937; --text-muted: #6b7280; --border-color: #e5e7eb; }
        body:not(.dark-mode) .rank-score { background: #f3f4f6; }
    </style>
</head>
<body class="dark-mode">
    <div id="refresh-container"><div id="refresh-bar"></div></div>

    <div class="header">
        <div><h2 class="fw-bold m-0">PAINEL <span style="color: var(--n1-color)">INFRA</span></h2><small class="text-muted" id="txt-agora">Atualizado: {{ agora }}</small></div>
        <button class="theme-switch" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i></button>
    </div>

    <div class="container-fluid p-0">
        
        <div class="stats-row">
            <div class="stat-card"><div><div class="stat-val" id="v-c-hj" style="color: var(--stat-today-c)">{{ dados.stats_hoje.criados_hoje }}</div><span class="stat-label">Criados Hoje</span></div><div class="stat-icon" style="color: var(--stat-today-c)"><i class="fa-solid fa-plus-circle"></i></div></div>
            <div class="stat-card"><div><div class="stat-val" id="v-s-hj" style="color: var(--stat-today-s)">{{ dados.stats_hoje.solucionados_hoje }}</div><span class="stat-label">Fechados Hoje</span></div><div class="stat-icon" style="color: var(--stat-today-s)"><i class="fa-solid fa-check-circle"></i></div></div>
            <div class="stat-card"><div><div class="stat-val" id="v-c-mes" style="color: var(--stat-month-c)">{{ dados.stats_mes.criados_mes }}</div><span class="stat-label">Criados Mês</span></div><div class="stat-icon" style="color: var(--stat-month-c)"><i class="fa-regular fa-calendar-plus"></i></div></div>
            <div class="stat-card"><div><div class="stat-val" id="v-s-mes" style="color: var(--stat-month-s)">{{ dados.stats_mes.solucionados_mes }}</div><span class="stat-label">Fechados Mês</span></div><div class="stat-icon" style="color: var(--stat-month-s)"><i class="fa-regular fa-calendar-check"></i></div></div>
        </div>

        <div class="alert-box" id="box-late" style="display: {% if dados.atrasados_total > 0 %}flex{% else %}none{% endif %}">
            <div class="d-flex align-items-center"><h2 class="m-0 me-3 fw-bold text-danger" id="v-late-tot">{{ dados.atrasados_total }}</h2><div><h5 class="m-0 fw-bold">Atrasados</h5><small>SLA > 16h Úteis</small></div></div>
            <div style="overflow-x:auto; white-space:nowrap; max-width: 60%;" id="list-late">
                {% for id in dados.atrasados_ids %}<a href="{{ base }}/glpi/front/ticket.form.php?id={{ id }}" target="_blank" class="btn-ticket">#{{ id }}</a>{% endfor %}
            </div>
        </div>

        <div class="new-tickets-box">
            <div class="d-flex align-items-center"><h2 class="m-0 me-3 fw-bold" style="color: var(--new-color)" id="v-new-tot">{{ dados.novos.total }}</h2><div><h5 class="m-0 fw-bold">Novos</h5><small>Fila de triagem</small></div></div>
            <div style="overflow-x:auto; white-space:nowrap; max-width: 60%;" id="list-new">
                {% if dados.novos.total > 0 %}{% for id in dados.novos.ids %}<a href="{{ base }}/glpi/front/ticket.form.php?id={{ id }}" target="_blank" class="btn-new">#{{ id }}</a>{% endfor %}{% else %}<span class="text-muted fst-italic me-3">Limpo ✨</span>{% endif %}
            </div>
        </div>

        <div class="row g-3">
            <div class="col-lg-8">
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <div class="card-queue novos">
                            <div class="queue-title">Novos</div><div class="queue-count" id="q-novos">{{ dados.novos.total }}</div>
                            <span id="alert-novos">{% if dados.novos.criticos > 0 %}<span class="sla-alert">{{ dados.novos.criticos }} > 30m</span>{% endif %}</span>
                            <div class="trend-badge" id="trend-novos">{% if dados.novos.variacao > 0 %}+{% endif %}{{ dados.novos.variacao }} vs Ontem</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-queue n1n2">
                            <div class="queue-title">N2</div><div class="queue-count n1n2" id="q-n1n2">{{ dados.n1n2.total }}</div>
                            <small class="text-muted" id="t-n1n2">{{ dados.n1n2.tempo }}</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-queue n3">
                            <div class="queue-title">N3</div><div class="queue-count n3" id="q-n3">{{ dados.n3.total }}</div>
                            <small class="text-muted" id="t-n3">{{ dados.n3.tempo }}</small>
                        </div>
                    </div>
                </div>
                <div class="chart-box"><canvas id="graficoFilas"></canvas></div>
            </div>
            <div class="col-lg-4">
                <div class="ranking-container">
                    <h5 class="text-center mb-3 fw-bold text-warning"><i class="fa-solid fa-trophy"></i> Top Resolutores</h5>
                    <ul class="nav nav-tabs nav-fill mb-3" id="rankTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" id="n2-tab" data-bs-toggle="tab" data-bs-target="#rank-n2" type="button">N2</button></li>
                        <li class="nav-item"><button class="nav-link" id="n1-tab" data-bs-toggle="tab" data-bs-target="#rank-n1" type="button">N1</button></li>
                        <li class="nav-item"><button class="nav-link" id="n3-tab" data-bs-toggle="tab" data-bs-target="#rank-n3" type="button">N3</button></li>
                    </ul>
                    <div class="tab-content" style="height: 250px; overflow-y: auto;">
                        <div class="tab-pane fade show active" id="rank-n2">{% for n,q in dados.rank_n2 %}<div class="rank-item"><span>{{ n }}</span><span class="rank-score">{{ q }}</span></div>{% endfor %}</div>
                        <div class="tab-pane fade" id="rank-n1">{% for n,q in dados.rank_n1 %}<div class="rank-item"><span>{{ n }}</span><span class="rank-score">{{ q }}</span></div>{% endfor %}</div>
                        <div class="tab-pane fade" id="rank-n3">{% for n,q in dados.rank_n3 %}<div class="rank-item"><span>{{ n }}</span><span class="rank-score">{{ q }}</span></div>{% endfor %}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const REFRESH_TIME = 120; // Tempo de refresh
        let timeLeft = 0; 
        const bar = document.getElementById('refresh-bar');
        const BASE_URL = "{{ base }}";

        // Atualização com Ajax
        function updateData() {
            fetch('/data')
                .then(r => r.json())
                .then(d => {
                    document.getElementById('txt-agora').innerText = 'Atualizado: ' + d.agora;
                    
                    // Stats
                    document.getElementById('v-c-hj').innerText = d.stats_hoje.criados_hoje;
                    document.getElementById('v-s-hj').innerText = d.stats_hoje.solucionados_hoje;
                    document.getElementById('v-c-mes').innerText = d.stats_mes.criados_mes;
                    document.getElementById('v-s-mes').innerText = d.stats_mes.solucionados_mes;
                    
                    // Filas
                    document.getElementById('q-novos').innerText = d.novos.total;
                    document.getElementById('v-new-tot').innerText = d.novos.total;
                    document.getElementById('q-n1n2').innerText = d.n1n2.total;
                    document.getElementById('t-n1n2').innerText = d.n1n2.tempo;
                    document.getElementById('q-n3').innerText = d.n3.total;
                    document.getElementById('t-n3').innerText = d.n3.tempo;

                    // Alerta de SLA
                    const slaBox = document.getElementById('alert-novos');
                    slaBox.innerHTML = d.novos.criticos > 0 ? `<span class="sla-alert">${d.novos.criticos} > 30m</span>` : '';
                    
                    // Lista de Novos
                    const listNew = document.getElementById('list-new');
                    if (d.novos.total > 0) {
                        listNew.innerHTML = d.novos.ids.map(id => `<a href="${BASE_URL}/glpi/front/ticket.form.php?id=${id}" target="_blank" class="btn-new">#${id}</a>`).join(' ');
                    } else {
                        listNew.innerHTML = '<span class="text-muted fst-italic me-3">Limpo ✨</span>';
                    }

                    // Lista de Atrasados
                    const boxLate = document.getElementById('box-late');
                    if (d.atrasados_total > 0) {
                        boxLate.style.display = 'flex';
                        document.getElementById('v-late-tot').innerText = d.atrasados_total;
                        document.getElementById('list-late').innerHTML = d.atrasados_ids.map(id => `<a href="${BASE_URL}/glpi/front/ticket.form.php?id=${id}" target="_blank" class="btn-ticket">#${id}</a>`).join(' ');
                    } else {
                        boxLate.style.display = 'none';
                    }

                    // Gráfico
                    if (myChart) {
                        myChart.data.datasets[0].data = [d.novos.total, d.n1n2.total, d.n3.total];
                        myChart.update();
                    }
                });
        }

        setInterval(() => { 
            timeLeft++; 
            const pct = (timeLeft / REFRESH_TIME) * 100; 
            if(bar) bar.style.width = pct + '%'; 
            if (timeLeft >= REFRESH_TIME) {
                timeLeft = 0;
                updateData(); 
            }
        }, 1000);

        // Tema
        const toggleBtn = document.querySelector('.theme-switch');
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); renderChart(); }
        
        // Chart Inicial
        let myChart;
        const ctx = document.getElementById('graficoFilas');
        if(ctx) {
            function renderChart() {
                const isDark = document.body.classList.contains('dark-mode');
                const color = isDark ? '#94a3b8' : '#6b7280';
                const grid = isDark ? '#334155' : '#e5e7eb';
                if (myChart) myChart.destroy();
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: { 
                        labels: ['Novos', 'N2', 'N3'], 
                        datasets: [{ label: 'Chamados', data: [{{ dados.novos.total }}, {{ dados.n1n2.total }}, {{ dados.n3.total }}], backgroundColor: ['#10b981', '#3b82f6', '#f97316'], borderRadius: 5 }] 
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: grid }, ticks: { color: color } }, x: { grid: { display: false }, ticks: { color: color } } } }
                });
            }
            renderChart();
        }
    </script>
</body>
</html>