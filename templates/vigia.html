<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Infra</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta http-equiv="refresh" content="120">

    <style>
        :root {
            --bg-body: #f3f4f6; --bg-card: #ffffff; --text-main: #1f2937; --text-muted: #6b7280;
            --n1-color: #3b82f6; --n2-color: #f59e0b; --n3-color: #ef4444;
            --border-color: #e5e7eb;
        }
        body.dark-mode {
            --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f8fafc; --text-muted: #94a3b8;
            --border-color: #334155;
        }
        body { background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; padding: 20px; transition: 0.3s; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .theme-switch { cursor: pointer; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .card-queue { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); height: 100%; }
        .queue-count { font-size: 3.5rem; font-weight: 900; line-height: 1; margin-bottom: 5px; }
        .n1 .queue-count { color: var(--n1-color); } .n2 .queue-count { color: var(--n2-color); } .n3 .queue-count { color: var(--n3-color); }
        .alert-box { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 12px; padding: 15px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); } 70% { box-shadow: 0 0 0 10px rgba(239,68,68,0); } 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); } }
        .btn-ticket { background: var(--bg-card); color: var(--n3-color); border: 1px solid var(--n3-color); padding: 4px 10px; border-radius: 6px; text-decoration: none; font-weight: bold; margin-left: 5px; }
        .ranking-container { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 15px; height: 100%; }
        .nav-tabs { border-bottom: 1px solid var(--border-color); }
        .nav-link { color: var(--text-muted); font-weight: 600; border: none; background: transparent; }
        .nav-link.active { color: var(--text-main); border-bottom: 3px solid var(--n1-color); background: transparent; }
        .rank-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .rank-pos { width: 30px; text-align: center; font-size: 1.2rem; margin-right: 10px; }
        .rank-name { flex-grow: 1; font-weight: 600; }
        .rank-score { background: var(--bg-body); padding: 2px 10px; border-radius: 10px; font-weight: bold; color: var(--n1-color); }
        .chart-box { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 10px; height: 300px; }
    </style>
</head>
<body>
    <div class="header">
        <div><h2 class="fw-bold m-0">GLPI <span style="color: var(--n1-color)">VIGIA</span></h2><small class="text-muted">Atualizado: {{ agora }}</small></div>
        <button class="theme-switch" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></button>
    </div>
    {% if erro %}<div class="alert alert-danger">{{ erro }}</div>{% endif %}
    <div class="container-fluid p-0">
        {% if dados.atrasados_total > 0 %}
        <div class="alert-box">
            <div class="d-flex align-items-center"><h2 class="m-0 me-3 fw-bold text-danger">{{ dados.atrasados_total }}</h2><div><h5 class="m-0 fw-bold">Atrasados</h5><small>Chamados crÃ­ticos</small></div></div>
            <div>{% for id in dados.atrasados_ids %}<a href="{{ base }}/glpi/front/ticket.form.php?id={{ id }}" target="_blank" class="btn-ticket">#{{ id }}</a>{% endfor %}</div>
        </div>
        {% endif %}
        <div class="row g-3">
            <div class="col-lg-8">
                <div class="row g-3 mb-3">
                    <div class="col-md-4"><div class="card-queue n1"><div class="queue-title">NÃ­vel 1 (Jr)</div><div class="queue-count">{{ dados.n1.total }}</div><small class="text-muted"><i class="fa-regular fa-clock"></i> {{ dados.n1.tempo }}</small></div></div>
                    <div class="col-md-4"><div class="card-queue n2"><div class="queue-title">NÃ­vel 2 (Pl)</div><div class="queue-count">{{ dados.n2.total }}</div><small class="text-muted"><i class="fa-regular fa-clock"></i> {{ dados.n2.tempo }}</small></div></div>
                    <div class="col-md-4"><div class="card-queue n3"><div class="queue-title">NÃ­vel 3 (Sr)</div><div class="queue-count">{{ dados.n3.total }}</div><small class="text-muted"><i class="fa-regular fa-clock"></i> {{ dados.n3.tempo }}</small></div></div>
                </div>
                <div class="chart-box"><canvas id="graficoFilas"></canvas></div>
            </div>
            <div class="col-lg-4">
                <div class="ranking-container">
                    <h5 class="fw-bold mb-3 text-center"><i class="fa-solid fa-trophy text-warning"></i> Top Resolutores</h5>
                    <ul class="nav nav-tabs nav-fill mb-3" id="rankTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" id="n2-tab" data-bs-toggle="tab" data-bs-target="#rank-n2" type="button">N2</button></li>
                        <li class="nav-item"><button class="nav-link" id="n1-tab" data-bs-toggle="tab" data-bs-target="#rank-n1" type="button">N1</button></li>
                        <li class="nav-item"><button class="nav-link" id="n3-tab" data-bs-toggle="tab" data-bs-target="#rank-n3" type="button">N3</button></li>
                    </ul>
                    <div class="tab-content" id="rankTabsContent" style="height: 400px; overflow-y: auto;">
                        <div class="tab-pane fade show active" id="rank-n2" role="tabpanel">{% if dados.rank_n2 %}{% for nome, qtd in dados.rank_n2 %}<div class="rank-item"><div class="rank-pos">{% if loop.index == 1 %}ðŸ¥‡{% elif loop.index == 2 %}ðŸ¥ˆ{% elif loop.index == 3 %}ðŸ¥‰{% else %}#{{ loop.index }}{% endif %}</div><div class="rank-name">{{ nome }}</div><div class="rank-score">{{ qtd }}</div></div>{% endfor %}{% else %}<p class="text-center text-muted mt-4">Sem dados N2.</p>{% endif %}</div>
                        <div class="tab-pane fade" id="rank-n1" role="tabpanel">{% if dados.rank_n1 %}{% for nome, qtd in dados.rank_n1 %}<div class="rank-item"><div class="rank-pos">{% if loop.index == 1 %}ðŸ¥‡{% elif loop.index == 2 %}ðŸ¥ˆ{% elif loop.index == 3 %}ðŸ¥‰{% else %}#{{ loop.index }}{% endif %}</div><div class="rank-name">{{ nome }}</div><div class="rank-score">{{ qtd }}</div></div>{% endfor %}{% else %}<p class="text-center text-muted mt-4">Sem dados N1.</p>{% endif %}</div>
                        <div class="tab-pane fade" id="rank-n3" role="tabpanel">{% if dados.rank_n3 %}{% for nome, qtd in dados.rank_n3 %}<div class="rank-item"><div class="rank-pos">{% if loop.index == 1 %}ðŸ¥‡{% elif loop.index == 2 %}ðŸ¥ˆ{% elif loop.index == 3 %}ðŸ¥‰{% else %}#{{ loop.index }}{% endif %}</div><div class="rank-name">{{ nome }}</div><div class="rank-score">{{ qtd }}</div></div>{% endfor %}{% else %}<p class="text-center text-muted mt-4">Sem dados N3.</p>{% endif %}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const toggleBtn = document.querySelector('.theme-switch');
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); renderChart(); }
        {% if dados %}
        let myChart;
        function renderChart() {
            const ctx = document.getElementById('graficoFilas');
            if (!ctx) return;
            const isDark = document.body.classList.contains('dark-mode');
            const color = isDark ? '#94a3b8' : '#6b7280';
            const grid = isDark ? '#334155' : '#e5e7eb';
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: ['N1', 'N2', 'N3'], datasets: [{ label: 'Chamados', data: [{{ dados.n1.total }}, {{ dados.n2.total }}, {{ dados.n3.total }}], backgroundColor: ['#3b82f6', '#f59e0b', '#ef4444'], borderRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: grid }, ticks: { color: color } }, x: { grid: { display: false }, ticks: { color: color } } } }
            });
        }
        document.addEventListener('DOMContentLoaded', renderChart);
        {% endif %}
    </script>
</body>
</html>