<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Infra</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Refresh AutomÃ¡tico -->
    <meta http-equiv="refresh" content="120">

    <style>
        :root {
            --bg-body: #f3f4f6; --bg-card: #ffffff; --text-main: #1f2937; --text-muted: #6b7280;
            --border-color: #e5e7eb;

            /* --- Cores do Card (MUDE AQUI) --- */
            --new-color: #10b981; /* Cor dos Novos */
            --n1-color: #3b82f6;  /* Cor do N1 */
            --n3-color: #535353;  /* Cor no N3 */
            
            /* --- COR DE ALERTA/ERRO (FIXA) --- */
            --danger-color: #dc2626; /* Vermelho escuro para Atrasados */
        }

        body.dark-mode {
            --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f8fafc; --text-muted: #94a3b8;
            --border-color: #334155;
        }

        body { background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; padding: 20px; transition: 0.3s; }
        
        /* BARRA DE REFRESH */
        #refresh-container { position: fixed; top: 0; left: 0; width: 100%; height: 5px; background: rgba(0,0,0,0.1); z-index: 9999; }
        #refresh-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--new-color), var(--n1-color), var(--n3-color)); transition: width 1s linear; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .theme-switch { cursor: pointer; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        
        /* CARDS FILAS */
        .card-queue { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); height: 100%; }
        .queue-count { font-size: 3.5rem; font-weight: 900; line-height: 1; margin-bottom: 5px; }
        
        /* APLICAÃ‡ÃƒO DAS CORES NOS CARDS */
        .novos .queue-count { color: var(--new-color); }
        .n1n2 .queue-count { color: var(--n1-color); } 
        .n3 .queue-count { color: var(--n3-color); } /* Agora esta cor Ã© independente dos alertas */

        /* BADGES */
        .trend-badge { font-size: 0.85rem; font-weight: 600; padding: 4px 10px; border-radius: 20px; display: inline-block; margin-top: 5px; background: var(--bg-body); border: 1px solid var(--border-color); }
        .trend-up { color: var(--danger-color); } 
        .trend-down { color: var(--new-color); }
        .sla-alert { color: var(--danger-color); font-weight: bold; animation: blink 1s infinite; display: block; font-size: 0.85rem; margin-top: 5px; }
        @keyframes blink { 50% { opacity: 0.5; } }
        
        /* Box de Atrasos */
        .alert-box { 
            background: rgba(220, 38, 38, 0.1); 
            border: 1px solid rgba(220, 38, 38, 0.3); 
            border-radius: 12px; padding: 15px; margin-bottom: 20px; 
            display: flex; align-items: center; justify-content: space-between; 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        
        /* BotÃµes de Chamados CritÃ­cos */
        .btn-ticket { 
            background: var(--bg-card); 
            color: var(--danger-color); 
            border: 1px solid var(--danger-color); 
            padding: 4px 10px; border-radius: 6px; 
            text-decoration: none; font-weight: bold; margin-left: 5px; 
        }
        .btn-ticket:hover { background: var(--danger-color); color: white; }
        
        /* BOX DE NOVOS */
        .new-tickets-box { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 15px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
        .btn-new { background: var(--bg-card); color: var(--new-color); border: 1px solid var(--new-color); padding: 4px 10px; border-radius: 6px; text-decoration: none; font-weight: bold; margin-left: 5px; }
        .btn-new:hover { background: var(--new-color); color: white; }

        /* RANKING */
        .ranking-container { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 15px; height: 100%; }
        .nav-tabs { border-bottom: 1px solid var(--border-color); }
        .nav-link { color: var(--text-muted); font-weight: 600; border: none; background: transparent; }
        .nav-link.active { color: var(--text-main); border-bottom: 3px solid var(--n1-color); background: transparent; }
        .rank-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .rank-pos { width: 30px; text-align: center; font-size: 1.2rem; margin-right: 10px; }
        .rank-name { flex-grow: 1; font-weight: 600; }
        .rank-score { background: var(--bg-body); padding: 2px 10px; border-radius: 10px; font-weight: bold; color: var(--n1-color); }
        .chart-box { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 10px; height: 300px; }
    </style>
</head>
<body>
    <div id="refresh-container"><div id="refresh-bar"></div></div>

    <div class="header">
        <div><h2 class="fw-bold m-0">DISPATCHER <span style="color: var(--n1-color)">INFRAESTRUTURA</span></h2><small class="text-muted">Atualizado: {{ agora }}</small></div>
        <button class="theme-switch" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></button>
    </div>
    
    {% if erro %}<div class="alert alert-danger">{{ erro }}</div>{% endif %}
    
    <div class="container-fluid p-0">
        <!-- Atrasados -->
        {% if dados.atrasados_total > 0 %}
        <div class="alert-box">
            <div class="d-flex align-items-center">
                <h2 class="m-0 me-3 fw-bold" style="color: var(--danger-color)">{{ dados.atrasados_total }}</h2>
                <div><h5 class="m-0 fw-bold">Atrasados</h5><small>Chamados crÃ­ticos</small></div>
            </div>
            <div>{% for id in dados.atrasados_ids %}<a href="{{ base }}/glpi/front/ticket.form.php?id={{ id }}" target="_blank" class="btn-ticket">#{{ id }}</a>{% endfor %}</div>
        </div>
        {% endif %}

        <!-- Novos -->
        <div class="new-tickets-box">
            <div class="d-flex align-items-center"><h2 class="m-0 me-3 fw-bold" style="color: var(--new-color)">{{ dados.novos.total }}</h2><div><h5 class="m-0 fw-bold">Novos Chamados</h5><small>Fila de triagem</small></div></div>
            <div>
                {% if dados.novos.total > 0 %}
                    {% for id in dados.novos.ids %}<a href="{{ base }}/glpi/front/ticket.form.php?id={{ id }}" target="_blank" class="btn-new">#{{ id }}</a>{% endfor %}
                {% else %}<span class="text-muted fst-italic me-3">Nenhum chamado novo (Limpo) âœ¨</span>{% endif %}
            </div>
        </div>

        <div class="row g-3">
            <div class="col-lg-8">
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <div class="card-queue novos">
                            <div class="queue-title">Novos</div>
                            <div class="queue-count">{{ dados.novos.total }}</div>
                            {% if dados.novos.criticos > 0 %}<span class="sla-alert"><i class="fa-solid fa-stopwatch"></i> {{ dados.novos.criticos }} > 30 min</span>{% endif %}
                            <div class="trend-badge {% if dados.novos.variacao > 0 %}trend-up{% else %}trend-down{% endif %}">{% if dados.novos.variacao > 0 %}+{% endif %}{{ dados.novos.variacao }} vs Ontem</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-queue n1n2">
                            <div class="queue-title">N1 & N2 (Jr/Pl)</div>
                            <div class="queue-count">{{ dados.n1n2.total }}</div>
                            <small class="text-muted"><i class="fa-regular fa-clock"></i> {{ dados.n1n2.tempo }}</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-queue n3">
                            <div class="queue-title">N3 (Sr)</div>
                            <div class="queue-count">{{ dados.n3.total }}</div>
                            <small class="text-muted"><i class="fa-regular fa-clock"></i> {{ dados.n3.tempo }}</small>
                        </div>
                    </div>
                </div>
                <div class="chart-box"><canvas id="graficoFilas"></canvas></div>
            </div>
            <div class="col-lg-4">
                <div class="ranking-container">
                    <h5 class="fw-bold mb-3 text-center"><i class="fa-solid fa-trophy text-warning"></i> Top Resolutores</h5>
                    <ul class="nav nav-tabs nav-fill mb-3" id="rankTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" id="n2-tab" data-bs-toggle="tab" data-bs-target="#rank-n2" type="button">N2</button></li>
                        <li class="nav-item"><button class="nav-link" id="n1-tab" data-bs-toggle="tab" data-bs-target="#rank-n1" type="button">N1</button></li>
                        <li class="nav-item"><button class="nav-link" id="n3-tab" data-bs-toggle="tab" data-bs-target="#rank-n3" type="button">N3</button></li>
                    </ul>
                    <div class="tab-content" id="rankTabsContent" style="height: 400px; overflow-y: auto;">
                        <div class="tab-pane fade show active" id="rank-n2" role="tabpanel">{% if dados.rank_n2 %}{% for nome, qtd in dados.rank_n2 %}<div class="rank-item"><div class="rank-pos">{% if loop.index == 1 %}ðŸ¥‡{% elif loop.index == 2 %}ðŸ¥ˆ{% elif loop.index == 3 %}ðŸ¥‰{% else %}#{{ loop.index }}{% endif %}</div><div class="rank-name">{{ nome }}</div><div class="rank-score">{{ qtd }}</div></div>{% endfor %}{% else %}<p class="text-center text-muted mt-4">Sem dados N2.</p>{% endif %}</div>
                        <div class="tab-pane fade" id="rank-n1" role="tabpanel">{% if dados.rank_n1 %}{% for nome, qtd in dados.rank_n1 %}<div class="rank-item"><div class="rank-pos">{% if loop.index == 1 %}ðŸ¥‡{% elif loop.index == 2 %}ðŸ¥ˆ{% elif loop.index == 3 %}ðŸ¥‰{% else %}#{{ loop.index }}{% endif %}</div><div class="rank-name">{{ nome }}</div><div class="rank-score">{{ qtd }}</div></div>{% endfor %}{% else %}<p class="text-center text-muted mt-4">Sem dados N1.</p>{% endif %}</div>
                        <div class="tab-pane fade" id="rank-n3" role="tabpanel">{% if dados.rank_n3 %}{% for nome, qtd in dados.rank_n3 %}<div class="rank-item"><div class="rank-pos">{% if loop.index == 1 %}ðŸ¥‡{% elif loop.index == 2 %}ðŸ¥ˆ{% elif loop.index == 3 %}ðŸ¥‰{% else %}#{{ loop.index }}{% endif %}</div><div class="rank-name">{{ nome }}</div><div class="rank-score">{{ qtd }}</div></div>{% endfor %}{% else %}<p class="text-center text-muted mt-4">Sem dados N3.</p>{% endif %}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const toggleBtn = document.querySelector('.theme-switch');
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); renderChart(); }
        
        // REFRESH BAR
        const REFRESH_TIME = 120; let timeLeft = 0; const bar = document.getElementById('refresh-bar');
        setInterval(() => { timeLeft++; const percentage = (timeLeft / REFRESH_TIME) * 100; if(bar) bar.style.width = percentage + '%'; if (timeLeft >= REFRESH_TIME) window.location.reload(); }, 1000);

        {% if dados %}
        let myChart;
        function renderChart() {
            const ctx = document.getElementById('graficoFilas');
            if (!ctx) return;
            
            // Pega as cores definidas no CSS (para ficar sincronizado)
            const style = getComputedStyle(document.body);
            const n1Color = style.getPropertyValue('--n1-color').trim();
            const n3Color = style.getPropertyValue('--n3-color').trim();
            const newColor = style.getPropertyValue('--new-color').trim();

            const isDark = document.body.classList.contains('dark-mode');
            const textColor = isDark ? '#94a3b8' : '#6b7280';
            const gridColor = isDark ? '#334155' : '#e5e7eb';

            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: { 
                    labels: ['Novos', 'N1 + N2', 'N3'], 
                    datasets: [{
                        label: 'Chamados', 
                        data: [{{ dados.novos.total }}, {{ dados.n1n2.total }}, {{ dados.n3.total }}], 
                        backgroundColor: [newColor, n1Color, n3Color], 
                        borderRadius: 5 
                    }] 
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { display: false }, ticks: { color: textColor } } } }
            });
        }
        document.addEventListener('DOMContentLoaded', renderChart);
        {% endif %}
    </script>
</body>
</html>